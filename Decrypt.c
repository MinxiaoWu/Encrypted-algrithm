#include <stdio.h>
#include <math.h>
#include <time.h>
#include <stdlib.h>
#include <sys/types.h>
#include <unistd.h>
#include <string.h>
#include "E function.h"
/*-----------------------------------------------------------------------------------------------------*/

int main(void)
{
    char t[300], a[11], b[11], c[5], s[325];
    int i=0, j=0, n=0, x[10], y[10], z[4];

    printf("=======================  Decrypted Model  =======================\n\n");
    printf("The ciphertext:\n\n ");
    while ((s[i]=getchar())!='#') /*密文读入*/
    {
        i++;
    } s[i]='\0';
    
    printf("\n\n");
    for ( i = 1; i <=65; i++)
    {
        printf("-");
    }
    printf("\n");

    //------------------------------------------------------------------------------------------//

    /*获取并破解密钥*/

    while (n < 10 )                //获取密钥和密文
    {
        a[n]=s[n];
        n++;
    } a[n]='\0';

    n=0;
    while (n < 10)
    {
        b[n]=s[strlen(s)-10+n];
        n++;
    } b[n]='\0';
    
    n=0;
    while (n < 4)
    {
        c[n]=s[strlen(s)-14+n];
        n++;
    } c[n]='\0';

    n=10;
    while (n < strlen(s)-14)
    {
        t[n-10]=s[n];
        n++;
    }t[n]='\0';
    

    S_i(a, x);                    //破解密钥
    S_i(b, y);
    S_i(c, z);

    //------------------------------------------------------------------------------------------//

    /*初次接线解密*/

    j=0;
    for ( i = 0; i < 10; i++)
    {
        while (*(t+j) != '\0')
        {
            if (pos(*(t+j), 'd') == x[i])
            {
                *(t+j)='<';
            }
            else if (pos(*(t+j), 'd') == y[i])
            {
                *(t+j)='>';
            }
            j++;
        }
        j=0;
        while (*(t+j) != '\0')
        {
            if (*(t+j) == '<')
            {
                *(t+j) = S(y[i], 0);
            }
            else if (*(t+j) == '>')
            {
                *(t+j) = S(x[i], 0);
            }
            j++;
        }
        j=0;
    }
    
    //------------------------------------------------------------------------------------------//

    /*转子解密*/

    n=0;
    while (*(t+n)!='\0')
    {                        /*初次转子解密*/
        E(z[0]+n, t+n, 0);
        E(z[1]+n/77, t+n, 0);
        E(z[2]+n/pow(77,2), t+n, 0);
        E(z[3]+n/pow(77,3), t+n, 0);

        R(t+n);              /*信号反射*/
                             /*二次转子解密*/
        D(z[3]+n/pow(77,3), t+n, 1);
        D(z[2]+n/pow(77,2), t+n, 1);
        D(z[1]+n/77, t+n, 1);
        D(z[0]+n, t+n, 0);
        n++;
    }

    //------------------------------------------------------------------------------------------//

    /*二次接线解密*/

    j=0;
    for ( i = 0; i < 10; i++)
    {
        while (*(t+j) != '\0')
        {
            if (pos(*(t+j), 'e') == x[i])
            {
                *(t+j)='<';
            }
            else if (pos(*(t+j), 'e') == y[i])
            {
                *(t+j)='>';
            }
            j++;
        }
        j=0;
        while (*(t+j) != '\0')
        {
            if (*(t+j) == '<')
            {
                *(t+j) = S(y[i], 1);
            }
            else if (*(t+j) == '>')
            {
                *(t+j) = S(x[i], 1);
            }
            j++;
        }
        j=0;
    }

    //------------------------------------------------------------------------------------------//

    printf("\n The plaintext:");
    printf("\n\n  ");
    printf("%s\n\n",t);

    for ( i = 1; i <=65; i++)
    {
        printf("=");
    }

    return 0;
}
/*-----------------------------------------------------------------------------------------------------*/